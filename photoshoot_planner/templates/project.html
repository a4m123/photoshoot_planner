{% extends 'base.html' %}
{% block content %}
<h2>–ü—Ä–æ–µ–∫—Ç: {{ project[1] }}</h2>
<a href="{{ url_for('user_projects', user_id=project[2]) }}" class="btn btn-secondary mb-3">–ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
<br>
<a href="{{ url_for('export_project_pdf', project_id=project[0]) }}" class="btn btn-outline-primary mt-3">
    üìÑ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å PDF-—Ä–∞—Å–∫–∞–¥—Ä–æ–≤–∫—É
</a>

<h3 class="mt-4">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–¥—Ä</h3>
<form method="post" enctype="multipart/form-data" action="{{ url_for('add_frame', project_id=project[0]) }}">
    <input type="text" name="description" class="form-control mb-2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–¥—Ä–∞" required>
    <input type="file" name="image" class="form-control mb-2">
    <input type="text" name="character_name" class="form-control mb-2" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
    <input type="datetime-local" name="shoot_time" class="form-control mb-2">
    <input type="text" name="location" placeholder="–õ–æ–∫–∞—Ü–∏—è (–∞–¥—Ä–µ—Å)" class="form-control mb-2">

    <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–¥—Ä</button>
</form>

<h4 class="mt-5">–ò–ª–∏ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å —ç—Å–∫–∏–∑:</h4>

<canvas id="sketchCanvas" width="600" height="400" style="border:1px solid #ccc;"></canvas><br>

<div class="mb-2">
  <label for="colorPicker">–¶–≤–µ—Ç –∫–∏—Å—Ç–∏:</label>
  <input type="color" id="colorPicker" value="#000000">

  <label for="brushSize" class="ms-3">–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏:</label>
  <input type="range" id="brushSize" min="1" max="20" value="2">

  <label for="layerSelector" class="ms-3">–°–ª–æ–π:</label>
  <select id="layerSelector">
    <option value="0" selected>–°–ª–æ–π 1</option>
    <option value="1">–°–ª–æ–π 2</option>
    <option value="2">–°–ª–æ–π 3</option>
  </select>
    <br>
  <button type="button" onclick="undo()">‚Ü∂ Undo</button>
  <button type="button" onclick="redo()">‚Ü∑ Redo</button>
  <button type="button" onclick="clearCanvas()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>


<button class="btn btn-warning mt-2" onclick="clearCanvas()">–û—á–∏—Å—Ç–∏—Ç—å</button>
<button class="btn btn-primary mt-2" onclick="submitSketch()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∫–∞–¥—Ä</button>

<form id="sketchForm" method="POST" action="{{ url_for('add_frame', project_id=project[0]) }}">
    <input type="hidden" name="description" value="–ù–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–π —ç—Å–∫–∏–∑">
    <input type="hidden" name="image_data" id="imageDataInput">
</form>
<script>
let canvas = document.getElementById("sketchCanvas");
let ctx = canvas.getContext("2d");

let drawing = false;
let lastX = 0, lastY = 0;
let brushColor = document.getElementById("colorPicker").value;
let brushSize = parseInt(document.getElementById("brushSize").value);
let currentLayerIndex = parseInt(document.getElementById("layerSelector").value);

// —Å–æ–∑–¥–∞—ë–º —Ç—Ä–∏ —Å–ª–æ—è (—Ç—Ä–∏ canvas)
let layers = [createLayer(), createLayer(), createLayer()];
let history = [], redoStack = [];

function createLayer() {
    let layer = document.createElement("canvas");
    layer.width = canvas.width;
    layer.height = canvas.height;
    return layer;
}

// –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
document.getElementById("colorPicker").oninput = e => brushColor = e.target.value;
document.getElementById("brushSize").oninput = e => brushSize = parseInt(e.target.value);
document.getElementById("layerSelector").onchange = e => currentLayerIndex = parseInt(e.target.value);

// –†–∏—Å–æ–≤–∞–Ω–∏–µ
canvas.onmousedown = e => {
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
    saveState();
};

canvas.onmouseup = () => drawing = false;
canvas.onmouseout = () => drawing = false;

canvas.onmousemove = e => {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    let layerCtx = layers[currentLayerIndex].getContext("2d");
    layerCtx.strokeStyle = brushColor;
    layerCtx.lineWidth = brushSize;
    layerCtx.lineCap = "round";

    layerCtx.beginPath();
    layerCtx.moveTo(lastX, lastY);
    layerCtx.lineTo(x, y);
    layerCtx.stroke();

    lastX = x;
    lastY = y;
    redraw(); // –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ —Å–ª–æ–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π canvas
};

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
function saveState() {
    const state = layers.map(l => l.toDataURL());
    history.push(state);
    redoStack = [];
}

// Undo/Redo
function undo() {
    if (history.length === 0) return;
    redoStack.push(layers.map(l => l.toDataURL()));
    const prev = history.pop();
    prev.forEach((data, i) => {
        let img = new Image();
        img.onload = () => {
            let ctx = layers[i].getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            redraw();
        };
        img.src = data;
    });
}

function redo() {
    if (redoStack.length === 0) return;
    history.push(layers.map(l => l.toDataURL()));
    const next = redoStack.pop();
    next.forEach((data, i) => {
        let img = new Image();
        img.onload = () => {
            let ctx = layers[i].getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            redraw();
        };
        img.src = data;
    });
}

// –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–ª–æ—ë–≤
function redraw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackground();
    drawGrid();
    for (let layer of layers) {
        ctx.drawImage(layer, 0, 0);
    }
}

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–ª–æ—ë–≤
function clearCanvas() {
    saveState();
    layers.forEach(layer => {
        layer.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
    });
    redraw();
}

// –°–µ—Ç–∫–∞
function drawGrid() {
    let step = 50;
    ctx.strokeStyle = "#ddd";
    ctx.lineWidth = 1;
    for (let x = 0; x <= canvas.width; x += step) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
    }
    for (let y = 0; y <= canvas.height; y += step) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
    }
}

// –§–æ–Ω
function drawBackground() {
    ctx.fillStyle = "#fefefe";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–≤—Å–µ —Å–ª–æ–∏ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è)
function submitSketch() {
    redraw(); // –æ–±–Ω–æ–≤–∏–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–æ—Ç–Ω–æ
    const imageData = canvas.toDataURL("image/png");
    document.getElementById("imageDataInput").value = imageData;
    document.getElementById("sketchForm").submit();
}

drawBackground();
drawGrid();
</script>

<h3 class="mt-5">–ö–∞–¥—Ä—ã</h3>
<div id="frame-container" class="row">
    {% for frame in frames %}
        <div class="col-md-3 mb-4 frame-card" data-id="{{ frame[0] }}" draggable="true">
            <div class="card h-100">
                <!-- Thumbnail triggers modal -->
                <a href="#" data-bs-toggle="modal" data-bs-target="#modal{{ frame[0] }}" draggable="true">
                    <img src="/uploads/thumbs/thumb_{{ frame[3] }}" class="card-img-top" alt="Sketch">
                </a>

                <div class="card-body">
                <h5 class="card-title">{{ frame[4] or "–ë–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" }}</h5>
                <p class="card-text">{{ frame[2] }}</p>
                <p><strong>–í—Ä–µ–º—è:</strong> {{ frame[5] or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</p>
                <p><strong>–õ–æ–∫–∞—Ü–∏—è:</strong> {{ frame[6] or '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</p>

                <!-- Delete button -->
                <form method="POST" action="{{ url_for('delete_frame', frame_id=frame[0], project_id=project[0]) }}">
                    <button type="submit" class="btn btn-sm btn-danger">üóë –£–¥–∞–ª–∏—Ç—å</button>
                </form>
                <!-- Edit button -->
                <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#editModal{{ frame[0] }}">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
        </div>

        <!-- Modal for full image -->
        <div class="modal fade" id="modal{{ frame[0] }}" tabindex="-1" aria-labelledby="modalLabel{{ frame[0] }}" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-body">
                <img src="/uploads/{{ frame[3] }}" class="img-fluid" alt="Full image">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            </div>
        </div>
        </div>

        <!-- Modal for editing frame -->
        <div class="modal fade" id="editModal{{ frame[0] }}" tabindex="-1" aria-labelledby="editModalLabel{{ frame[0] }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <form method="POST" action="{{ url_for('edit_frame', frame_id=frame[0], project_id=project[0]) }}">
                <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel{{ frame[0] }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
                        <input type="text" name="character_name" class="form-control" value="{{ frame[4] }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea name="description" class="form-control" rows="3">{{ frame[2] }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–í—Ä–µ–º—è —Å—ä–µ–º–∫–∏</label>
                        <input type="datetime-local" name="shoot_time" class="form-control" value="{{ frame[5] }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–õ–æ–∫–∞—Ü–∏—è</label>
                        <input type="text" name="location" class="form-control" value="{{ frame[6] }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                        <input type="file" name="image" class="form-control">
                        <small class="form-text text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</small>
                    </div>
                </div>
                <div class="modal-footer">
                <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
            </div>
        </div>
        </div>

    {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("frame-container");
    let dragged;

    document.querySelectorAll(".frame-card").forEach(card => {
        card.addEventListener("dragstart", e => {
            dragged = card;
            card.style.opacity = 0.5;
        });

        card.addEventListener("dragend", e => {
            card.style.opacity = "";
        });

        card.addEventListener("dragover", e => e.preventDefault());

        card.addEventListener("drop", e => {
            e.preventDefault();
            if (dragged && dragged !== card) {
                container.insertBefore(dragged, card);
                saveNewOrder();
            }
        });
    });

    function saveNewOrder() {
        const ids = Array.from(document.querySelectorAll(".frame-card")).map(c => c.dataset.id);
        fetch("/update_frame_order", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ order: ids })
        }).then(res => {
            if (!res.ok) alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Ä—è–¥–∫–∞");
        });
    }
});
</script>


{% endblock %}

